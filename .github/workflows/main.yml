name: CI/CD Pipeline - Despliegue Local

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  IMAGE_NAME: proyecto1-app
  IMAGE_TAG: latest
  APP_SOURCE_DIR: app_source/ # <--- Â¡AÃ‘ADIDO! Directorio de la aplicaciÃ³n

jobs:
  # =================================================================
  # 1. Seguridad y Build (Combinado)
  # =================================================================
  security_and_build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout CÃ³digo Fuente
        uses: actions/checkout@v4

      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      # CORRECCIÃ“N: Usa working-directory para encontrar package.json
      - name: Instalar Dependencias
        run: npm install
        working-directory: ${{ env.APP_SOURCE_DIR }} # <-- FIX: Busca el package.json aquÃ­

      # --- PASOS DE SEGURIDAD ---

      - name: ðŸ”’ AnÃ¡lisis EstÃ¡tico de CÃ³digo (ESLint)
        # Usamos 'npm run lint' definido en package.json
        run: npm run lint
        working-directory: ${{ env.APP_SOURCE_DIR }} # <-- FIX

      #- name: ðŸ”’ AnÃ¡lisis de Vulnerabilidades (Snyk)
      #  uses: snyk/actions/node@master
      #  env:
      #    SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      #  with:
      #    command: test
          # Â¡CORRECCIÃ“N! Indicamos la ruta exacta del package.json
      #    args: --file=app_source/package.json

      - name: ðŸ“œ Generar SBOM (CycloneDX)
        # Nota: Asumiendo que anchore/sbom-action@main es temporalmente estable
        uses: anchore/sbom-action@main
        with:
          format: cyclonedx
          output-file: sbom.json

      - name: âœ… Ejecutar Tests de Unidad/IntegraciÃ³n
        run: npm test
        working-directory: ${{ env.APP_SOURCE_DIR }} # <-- FIX

      # --- CONSTRUCCIÃ“N Y TAGGING LOCAL ---

      - name: ðŸ³ Construir Imagen Docker
        # El contexto (el punto '.') debe ser la carpeta donde estÃ¡ el Dockerfile
        run: docker build -t ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} .
        working-directory: ${{ env.APP_SOURCE_DIR }} # <-- FIX

      - name: Subir SBOM y Archivos de Infraestructura como Artefactos
        uses: actions/upload-artifact@v4
        with:
          name: deployment-artifacts
          path: |
            sbom.json
            infra/ # Carpeta Terraform
            ${{ env.APP_SOURCE_DIR }}Dockerfile # Dockerfile especÃ­fico
            ${{ env.APP_SOURCE_DIR }} # El cÃ³digo fuente de la app

  # =================================================================
  # 2. Despliegue con Terraform
# =================================================================
deploy_local:
    needs: security_and_build
    runs-on: ubuntu-latest
    env:
        TERRAFORM_DIR: infra/
        IMAGE_NAME: proyecto1-app
        IMAGE_TAG: latest
        APP_SOURCE_DIR: app_source/ 
    steps:
        - name: Checkout CÃ³digo Fuente y Terraform
          uses: actions/checkout@v4
          
        # CORRECCIÃ“N: Necesita working-directory para encontrar el Dockerfile de nuevo
        - name: ðŸ³ Re-construir Imagen Docker (para este runner)
          run: docker build -t ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} .
          working-directory: ${{ env.APP_SOURCE_DIR }} # <-- FIX
          
        - name: Instalar Terraform
          uses: hashicorp/setup-terraform@v3
          with:
            terraform_version: 1.6.0
            
        # ðŸ—‘ï¸ NUEVO PASO: Eliminar bloqueo de versiÃ³n
        # Esto soluciona el error 'openpgp: key expired' al forzar a Terraform a regenerar
        # la dependencia del proveedor `kreuzwerker/docker`.
        - name: ðŸ—‘ï¸ Eliminar Bloqueo de Terraform
          run: rm -f .terraform.lock.hcl
          working-directory: ${{ env.TERRAFORM_DIR }}
            
        # ðŸ› ï¸ Terraform Init
        - name: ðŸ› ï¸ Terraform Init
          # El flag -upgrade es esencial junto con la eliminaciÃ³n del archivo de bloqueo
          run: terraform init -upgrade
          working-directory: ${{ env.TERRAFORM_DIR }}
          
        # ðŸš€ Terraform Apply (Desplegar el stack de App, Prometheus y Grafana)
        - name: ðŸš€ Terraform Apply
          run: terraform apply -auto-approve
          working-directory: ${{ env.TERRAFORM_DIR }}
