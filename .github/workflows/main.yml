name: CI/CD Pipeline - Despliegue Local

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  IMAGE_NAME: proyecto1-app
  IMAGE_TAG: latest
  APP_SOURCE_DIR: app_source/ # <--- Â¡AÃ‘ADIDO! Directorio de la aplicaciÃ³n

jobs:
  # =================================================================
  # 1. Seguridad y Build (Combinado)
  # =================================================================
  security_and_build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout CÃ³digo Fuente
        uses: actions/checkout@v4

      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      # CORRECCIÃ“N: Usa working-directory para encontrar package.json
      - name: Instalar Dependencias
        run: npm install
        working-directory: ${{ env.APP_SOURCE_DIR }} # <-- FIX: Busca el package.json aquÃ­

      # --- PASOS DE SEGURIDAD ---

      - name: ðŸ”’ AnÃ¡lisis EstÃ¡tico de CÃ³digo (ESLint)
        # Usamos 'npm run lint' definido en package.json
        run: npm run lint
        working-directory: ${{ env.APP_SOURCE_DIR }} # <-- FIX
        
      #- name: ðŸ”’ AnÃ¡lisis de Vulnerabilidades (Snyk)
      #  run: |
      #    cd ${{ env.APP_SOURCE_DIR }}
      #    snyk test --severity-threshold=high || true
      #  env:
      #    SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
          # Cambiamos al subdirectorio donde estÃ¡ el cÃ³digo real
        
      - name: ðŸ”’ AnÃ¡lisis de Vulnerabilidades (Snyk)
        uses: snyk/actions@master
        continue-on-error: true
        with:
          command: test
          args: '--severity-threshold=high'   # opcional pero recomendado
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        working-directory: ${{ env.APP_SOURCE_DIR }}
                  
      - name: ðŸ“œ Generar SBOM (CycloneDX)
        # Nota: Asumiendo que anchore/sbom-action@main es temporalmente estable
        uses: anchore/sbom-action@main
        with:
          format: cyclonedx
          output-file: sbom.json

      - name: âœ… Ejecutar Tests de Unidad/IntegraciÃ³n
        run: npm test
        working-directory: ${{ env.APP_SOURCE_DIR }} # <-- FIX

      # --- CONSTRUCCIÃ“N Y TAGGING LOCAL ---

      - name: ðŸ³ Construir Imagen Docker
        # El contexto (el punto '.') debe ser la carpeta donde estÃ¡ el Dockerfile
        run: docker build -t ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} .
        working-directory: ${{ env.APP_SOURCE_DIR }} # <-- FIX

      - name: Subir SBOM y Archivos de Infraestructura como Artefactos
        uses: actions/upload-artifact@v4
        with:
          name: deployment-artifacts
          path: |
            sbom.json
            infra/ # Carpeta Terraform
            ${{ env.APP_SOURCE_DIR }}Dockerfile # Dockerfile especÃ­fico
            ${{ env.APP_SOURCE_DIR }} # El cÃ³digo fuente de la app

  # =================================================================
  # 2. Despliegue con Terraform
  # =================================================================
  deploy_local:
      needs: security_and_build
      runs-on: rsimoesv2
      env:
        TERRAFORM_DIR: infra/
        IMAGE_NAME: proyecto1-app
        IMAGE_TAG: latest
        APP_SOURCE_DIR: app_source/ # <--- Â¡AÃ‘ADIDO!
      steps:
        - name: Checkout CÃ³digo Fuente y Terraform
          uses: actions/checkout@v4

      # CORRECCIÃ“N: Necesita working-directory para encontrar el Dockerfile de nuevo
        - name: ðŸ³ Re-construir Imagen Docker (para este runner)
          run: docker build -t ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} .
          working-directory: ${{ env.APP_SOURCE_DIR }} # <-- FIX

        - name: Instalar Terraform
          uses: hashicorp/setup-terraform@v3
          with:
            # Reemplaza 1.6.0 por una versiÃ³n anterior, como 1.5.7 o 1.4.6.
            # Esto puede relajar la estrictez de la verificaciÃ³n PGP.
            terraform_version: 1.5.7
            
# âž¡ï¸ PASO AÃ‘ADIDO: Eliminar el bloqueo de versiÃ³n antiguo
        - name: ðŸ—‘ï¸ Eliminar Bloqueo de Terraform
          run: rm -f .terraform.lock.hcl
          working-directory: ${{ env.TERRAFORM_DIR }} # Ejecutar dentro de la carpeta infra/
      
      # ðŸ› ï¸ Terraform Init
        - name: ðŸ› ï¸ Terraform Init
        # AÃ±adimos la variable de entorno para ignorar el error de PGP: key expired
          env: 
            TF_SKIP_PROVIDER_VERIFICATION: true
          run: terraform init -upgrade
          working-directory: ${{ env.TERRAFORM_DIR }}

      # ðŸš€ Terraform Apply (Desplegar el stack de App, Prometheus y Grafana)
        - name: ðŸš€ Terraform Apply
          run: terraform apply -auto-approve
          working-directory: ${{ env.TERRAFORM_DIR }}
